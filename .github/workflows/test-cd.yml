name: Maintenance Test

on:
  workflow_dispatch:

jobs:
  maintenance:
    runs-on: ubuntu-latest

    steps:

    - name: Create + attach UptimeRobot MW (reliable)
      env:
          UR_API_KEY: ${{ secrets.UPTIME_ROBOT_API_KEY }}
      run: |
          set -euo pipefail
      
          # 0) jq на раннері
          sudo apt-get update -y >/dev/null
          sudo apt-get install -y jq >/dev/null
      
          START_TIME=$(( $(date +%s) + 300 ))   # +5 хв
          DURATION=5                             # хвилини!
      
          # 1) Створюємо MW (form-encoded, snake_case)
          curl -sS -X POST "https://api.uptimerobot.com/v2/newMWindow" \
            -H "Content-Type: application/x-www-form-urlencoded" \
            --data-urlencode "api_key=${UR_API_KEY}" \
            --data-urlencode "friendly_name=deploy_maintenance" \
            --data-urlencode "type=1" \
            --data-urlencode "start_time=${START_TIME}" \
            --data-urlencode "duration=${DURATION}" \
            -o ur.json
      
          echo "Create MW response:" && cat ur.json
          if [ "$(jq -r '.stat' ur.json)" != "ok" ]; then
            echo "Failed to create MW"; exit 1
          fi
      
          UR_ID=$(jq -r '.mwindow.id' ur.json)
          echo "UR_MW_ID=$UR_ID" >> $GITHUB_ENV
          echo "MW ID: $UR_ID"
      
          # 2) Прикріплюємо монітори ОДНИМ запитом (editMWindow + monitor_ids)
          #    формат: ID-и через дефіс, без пробілів
          MONITOR_IDS="801786487-801234567"   # <<< ЗАМІНИ на свої
      
          curl -sS -X POST "https://api.uptimerobot.com/v2/editMWindow" \
            -H "Content-Type: application/x-www-form-urlencoded" \
            --data-urlencode "api_key=${UR_API_KEY}" \
            --data-urlencode "id=${UR_ID}" \
            --data-urlencode "monitor_ids=${MONITOR_IDS}" \
            -o ur_edit.json
      
          echo "Attach monitors response:" && cat ur_edit.json
          if [ "$(jq -r '.stat' ur_edit.json)" != "ok" ]; then
            echo "Failed to attach monitors to MW"; exit 1
          fi

    # -------- WAIT 5 MINUTES --------
    - name: Wait until MW auto-ends
      run: |
        echo "Sleeping for 5 minutes..."
        sleep 300


    # -------- DELETE PagerDuty MW --------
    - name: Disable PagerDuty MW
      if: env.PD_MW_ID != ''
      run: |
        curl -X DELETE "https://api.pagerduty.com/maintenance_windows/${{ env.PD_MW_ID }}" \
          -H "Authorization: Token token=${{ secrets.PAGERDUTY_API_KEY }}" \
          -H "Accept: application/vnd.pagerduty+json;version=2"
        echo "PagerDuty MW disabled"


    # -------- DELETE UptimeRobot MW --------
    - name: Disable UptimeRobot MW
      if: env.UR_MW_ID != ''
      run: |
        curl -X POST "https://api.uptimerobot.com/v2/deleteMWindow" \
          -H "Content-Type: application/x-www-form-urlencoded" \
          --data-urlencode "api_key=${{ secrets.UPTIME_ROBOT_API_KEY }}" \
          --data-urlencode "id=${{ env.UR_MW_ID }}"
        echo "UptimeRobot MW disabled"
