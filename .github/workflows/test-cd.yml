name: Maintenance Test

on:
  workflow_dispatch:

jobs:
  maintenance:
    runs-on: ubuntu-latest

    steps:

    - name: Enable UptimeRobot MW (with monitorIds)
      env:
          UR_API_KEY: ${{ secrets.UPTIME_ROBOT_API_KEY }}
          # Числові ID моніторів (через кому)
          UR_MON_IDS: "801786487,801234567"
      run: |
          START_TIME=$(( $(date +%s) + 30 ))   # старт через 5 хв
          DURATION=5                            # тривалість 5 хв
      
          JSON_BODY=$(jq -n \
            --arg key   "$UR_API_KEY" \
            --arg name  "deploy-maintenance" \
            --argjson t 1 \
            --argjson st "$START_TIME" \
            --argjson du "$DURATION" \
            --arg mons  "[$(echo "$UR_MON_IDS" | sed 's/,/, /g')]" \
            '{
               apiKey:      $key,
               friendlyName:$name,
               type:        $t,
               startTime:   $st,
               duration:    $du,
               monitorIds:  ( $mons | fromjson )
             }')
      
          echo "$JSON_BODY" | jq
      
          curl -sS -X POST "https://api.uptimerobot.com/v2/newMWindow" \
            -H "Content-Type: application/json" \
            -d "$JSON_BODY" \
            -o ur.json
      
          echo "UptimeRobot response:" && cat ur.json
          UR_ID=$(jq -r '.mwindow.id // .mWindow.id // empty' ur.json)
          echo "UR_MW_ID=$UR_ID" >> $GITHUB_ENV
          echo "UptimeRobot MW ID: $UR_ID"
      

    # -------- WAIT 5 MINUTES --------
    - name: Wait until MW auto-ends
      run: |
        echo "Sleeping for 5 minutes..."
        sleep 300


    # -------- DELETE PagerDuty MW --------
    - name: Disable PagerDuty MW
      if: env.PD_MW_ID != ''
      run: |
        curl -X DELETE "https://api.pagerduty.com/maintenance_windows/${{ env.PD_MW_ID }}" \
          -H "Authorization: Token token=${{ secrets.PAGERDUTY_API_KEY }}" \
          -H "Accept: application/vnd.pagerduty+json;version=2"
        echo "PagerDuty MW disabled"


    # -------- DELETE UptimeRobot MW --------
    - name: Disable UptimeRobot MW
      if: env.UR_MW_ID != ''
      run: |
        curl -X POST "https://api.uptimerobot.com/v2/deleteMWindow" \
          -H "Content-Type: application/x-www-form-urlencoded" \
          --data-urlencode "api_key=${{ secrets.UPTIME_ROBOT_API_KEY }}" \
          --data-urlencode "id=${{ env.UR_MW_ID }}"
        echo "UptimeRobot MW disabled"
