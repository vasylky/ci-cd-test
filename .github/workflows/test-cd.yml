name: Maintenance Windows Only

on:
  workflow_dispatch:

jobs:
  maintenance:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v3
    # ----------------------------
    - name: Enable UptimeRobot Maintenance Window
      run: |
          START_TIME=$(($(date +%s) + 300))   # Start in 5 minutes
          DURATION=15
      
          curl -X POST "https://api.uptimerobot.com/v2/newMWindow" \
            -H "Content-Type: application/x-www-form-urlencoded" \
            -d "api_key=${{ secrets.UPTIME_ROBOT_API_KEY }}" \
            -d "friendly_name=deploy-maintenance" \
            -d "type=1" \
            -d "start_time=$START_TIME" \
            -d "duration=$DURATION" \
            -o ur.json
      
          echo "UptimeRobot response:"
          cat ur.json
      
          UR_ID=$(jq -r '.mwindow.id' ur.json)
      
          if [ "$UR_ID" = "null" ] || [ -z "$UR_ID" ]; then
            echo "âŒ ERROR: UptimeRobot ID not found"
            exit 1
          fi
      
          echo "UR_MW_ID=$UR_ID" >> $GITHUB_ENV
          echo "âœ… UptimeRobot MW ID: $UR_ID (starts in 5 minutes)"
      


    - name: Enable PagerDuty Maintenance Window
      run: |
            START=$(date -u -d "+5 minutes" +"%Y-%m-%dT%H:%M:%SZ")
            END=$(date -u -d "+20 minutes" +"%Y-%m-%dT%H:%M:%SZ")  # 15 min duration
        
            curl -X POST "https://api.pagerduty.com/maintenance_windows" \
              -H "Content-Type: application/json" \
              -H "Accept: application/vnd.pagerduty+json;version=2" \
              -H "Authorization: Token token=${{ secrets.PAGERDUTY_API_KEY }}" \
              -d "{
                \"maintenance_window\": {
                  \"type\": \"maintenance_window\",
                  \"start_time\": \"$START\",
                  \"end_time\": \"$END\",
                  \"description\": \"Deploy Test Window\",
                  \"services\": [{
                    \"id\": \"${{ secrets.PAGERDUTY_SERVICE_ID }}\",
                    \"type\": \"service_reference\"
                  }]
                }
              }" -o pd.json
        
            echo "PagerDuty response:"
            cat pd.json
        
            PD_ID=$(jq -r '.maintenance_window.id' pd.json)
        
            if [ "$PD_ID" = "null" ] || [ -z "$PD_ID" ]; then
              echo "âŒ ERROR: PagerDuty ID not found"
              exit 1
            fi
        
            echo "PD_MW_ID=$PD_ID" >> $GITHUB_ENV
            echo "âœ… PagerDuty MW ID: $PD_ID (starts in 5 minutes)"
        


    - name: Disable PagerDuty MW
      if: always() && env.PD_MW_ID != ''
      run: |
        curl -X DELETE "https://api.pagerduty.com/maintenance_windows/${{ env.PD_MW_ID }}" \
          -H "Authorization: Token token=${{ secrets.PAGERDUTY_API_KEY }}" \
          -H "Accept: application/vnd.pagerduty+json;version=2"
        echo "ðŸŸ¢ PagerDuty MW disabled"


    - name: Disable UptimeRobot MW
      if: always() && env.UR_MW_ID != ''
      run: |
        curl -X POST "https://api.uptimerobot.com/v2/deleteMWindow" \
          -H "Content-Type: application/x-www-form-urlencoded" \
          -d "api_key=${{ secrets.UPTIME_ROBOT_API_KEY }}" \
          -d "id=${{ env.UR_MW_ID }}"
        echo "ðŸŸ¢ UptimeRobot MW disabled"
